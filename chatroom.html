<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>YSA Chatroom</title>
<style>
:root{--turf-blue:#3B9AE1;--white:#fff;--dark:#0f172a;--light-dark:#1e293b;}
body{margin:0;font-family:Arial,sans-serif;background-color:var(--dark);color:var(--white);height:100vh;display:grid;grid-template-rows:60px 1fr;grid-template-columns:200px 1fr 250px;grid-template-areas:"topbar topbar topbar""sidebar chat friends";}
.topbar{grid-area:topbar;background-color:var(--turf-blue);display:flex;align-items:center;justify-content:space-between;padding:0 20px;color:var(--white);}
.topbar .logo{font-size:1.4em;font-weight:bold;}
.sidebar{grid-area:sidebar;background-color:var(--light-dark);display:flex;flex-direction:column;align-items:center;padding-top:20px;border-right:2px solid var(--turf-blue);}
.sidebar button{width:80%;margin:10px 0;padding:10px;background-color:var(--turf-blue);border:none;border-radius:8px;color:var(--white);cursor:pointer;font-weight:bold;}
.sidebar button:hover{background-color:#3587c5;}
.chat{grid-area:chat;display:flex;flex-direction:column;align-items:center;padding:10px;background-color:var(--dark);}
.chat-box{width:90%;max-width:600px;flex:1;overflow-y:auto;border-radius:10px;background:var(--light-dark);padding:10px;border:2px solid var(--turf-blue);}
.message{background-color:#22314b;border-radius:10px;padding:8px 12px;margin:8px 0;display:flex;gap:10px;}
.message img.pfp{width:35px;height:35px;border-radius:50%;}
.msg-content{flex:1;}
.msg-content img{max-width:100%;border-radius:8px;margin-top:5px;}
.input-area{width:90%;max-width:600px;display:flex;gap:5px;margin-top:10px;}
.input-area input[type="text"]{flex:1;padding:10px;border:none;border-radius:8px;}
.input-area button{background:var(--turf-blue);border:none;color:var(--white);border-radius:8px;padding:10px 15px;cursor:pointer;}
.input-area button:hover{background:#3587c5;}
.friends{grid-area:friends;background-color:var(--light-dark);border-left:2px solid var(--turf-blue);padding:20px;display:flex;flex-direction:column;}
.friends h3{margin:0 0 10px;color:var(--turf-blue);text-align:center;}
.friend-list{flex:1;overflow-y:auto;}
.friend{display:flex;align-items:center;gap:10px;margin:5px 0;}
.friend .status{width:10px;height:10px;background:#00ff55;border-radius:50%;}
.trends{border-top:1px solid var(--turf-blue);margin-top:10px;padding-top:10px;}
</style>
</head>
<body>

<div class="topbar"><div class="logo">YSA</div></div>

<div class="sidebar">
  <button>News</button>
  <button>Likes</button>
  <button>Saves</button>
</div>

<div class="chat">
  <div class="chat-box" id="chatBox"></div>
  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message...">
    <input type="file" id="imgInput" accept="image/*">
    <button id="sendBtn">Send</button>
  </div>
</div>

<div class="friends">
  <h3>Friends Online</h3>
  <div class="friend-list" id="friendList"></div>
  <div class="trends"><h3>Trends</h3><p>— Coming soon —</p></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, onChildAdded, push, set, remove, serverTimestamp, onValue, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyCKfQ4vW-oR-CGJ0bpRd-wF-nsawLk8X8w",
  authDomain:"testweb-afd53.firebaseapp.com",
  databaseURL:"https://testweb-afd53-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"testweb-afd53",
  storageBucket:"testweb-afd53.appspot.com",
  messagingSenderId:"256254284539",
  appId:"1:256254284539:web:2e3543191c27a36441165e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const imgInput = document.getElementById("imgInput");
const sendBtn = document.getElementById("sendBtn");
const friendList = document.getElementById("friendList");

let uid, username, profileURL = "https://via.placeholder.com/40";

onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "index.html";
  uid = user.uid;

  // Get locked username from Firebase or localStorage
  const dbRef = ref(db);
  const snap = await get(child(dbRef, `usernames/${uid}`));
  if (snap.exists()) username = snap.val();
  else {
    alert("Username not found. Please login again.");
    auth.signOut();
    return window.location.href = "index.html";
  }

  // Set online
  const userRef = ref(db, `onlineUsers/${uid}`);
  set(userRef, { name: username, online:true });
  window.addEventListener("beforeunload", () => remove(userRef));

  // Load existing chat
  const chatRef = ref(db, "messages");
  onChildAdded(chatRef, snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<img src="${msg.photoURL||profileURL}" class="pfp">
      <div class="msg-content"><b style="color:var(--turf-blue)">${msg.name}</b><br>${msg.text||""}</div>`;
    if (msg.imageURL){
      const img = document.createElement("img"); img.src = msg.imageURL;
      div.querySelector(".msg-content").appendChild(img);
    }
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // Show friends online
  const usersRef = ref(db, "onlineUsers");
  onValue(usersRef, snapshot => {
    friendList.innerHTML = "";
    snapshot.forEach(snap => {
      const u = snap.val();
      if (u.online){
        const div = document.createElement("div");
        div.className = "friend";
        div.innerHTML = `<div class="status"></div><span>${u.name}</span>`;
        friendList.appendChild(div);
      }
    });
  });
});

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e=>{if(e.key==="Enter") sendMessage()});

async function sendMessage(){
  const text = msgInput.value.trim();
  const file = imgInput.files[0];
  if (!text && !file) return;

  let imageURL=null;
  if(file){
    const storageRef = sRef(storage, `images/${uid}-${Date.now()}-${file.name}`);
    await uploadBytes(storageRef,file);
    imageURL = await getDownloadURL(storageRef);
  }

  await push(ref(db,"messages"),{
    uid,
    name: username,
    photoURL: profileURL,
    text: text||"",
    imageURL,
    timestamp: serverTimestamp()
  });

  msgInput.value=""; imgInput.value="";
}
</script>
</body>
</html>
