<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign in — Retro Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f0f12;--hero:#0c1a26;--accent:#8bd3ff;--muted:#9aa6b2;--card:#0f1720;--glass:rgba(255,255,255,0.03);--radius:14px;}
    html,body{height:100%;margin:0;font-family:Inter,system-ui;}
    body{background:linear-gradient(180deg,#071122 0%,#0c0d10 100%);color:#e6eef7;display:flex;align-items:center;justify-content:center;padding:32px;}
    .wrap{width:100%;max-width:1100px;height:80vh;display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center;}
    .hero{background:radial-gradient(600px 200px at 10% 20%,rgba(139,211,255,0.06),transparent 10%),linear-gradient(135deg,rgba(139,211,255,0.02),transparent 60%),var(--hero);border-radius:var(--radius);padding:48px;box-shadow:0 10px 30px rgba(2,6,12,0.6);display:flex;flex-direction:column;justify-content:center;}
    .hero h1{font-family:"Playfair Display",serif;font-size:54px;margin:0 0 12px;line-height:1;color:#fff;}
    .hero p{margin:0;color:var(--muted);font-size:18px;max-width:55ch;}
    .hero .tag{display:inline-block;margin-top:20px;padding:8px 14px;background:rgba(139,211,255,0.06);color:var(--accent);border-radius:999px;font-weight:600;font-size:13px;}
    .card{background:rgba(255,255,255,0.02);border-radius:var(--radius);padding:28px;box-shadow:0 12px 34px rgba(1,5,10,0.7);border:1px solid rgba(255,255,255,0.03);min-height:320px;display:flex;flex-direction:column;justify-content:center;}
    input,button{font-size:15px;border-radius:10px;}
    input{padding:12px 14px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:#eaf6ff;}
    button{cursor:pointer;}
    button.primary{background:linear-gradient(90deg,var(--accent),#6ed0ff);color:#022331;border:none;padding:12px 14px;font-weight:700;}
    button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:10px 12px;font-weight:600;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <span class="tag">community • journals • moments</span>
      <h1>A quiet place to share your thoughts</h1>
      <p>Join the conversation — private, simple, sincere.</p>
    </section>

    <aside class="card">
      <h2>Sign in to your account</h2>
      <p class="lead">Enter your email or continue with Google.</p>

      <form id="authForm" onsubmit="return false;">
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" required>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" required>
        <label><input type="checkbox" id="rememberMe"> Remember me</label>
        <label>Secret Code (optional)</label>
        <input id="secret" type="text" placeholder="Enter secret code if you have one">
        <div class="controls">
          <button class="primary" id="signBtn">Sign in</button>
          <button class="ghost" id="toggleMode" type="button">Create account</button>
        </div>
        <div class="controls">
          <button id="googleBtn" class="ghost" type="button">Google</button>
          <button id="guestBtn" class="ghost" type="button">Guest</button>
        </div>
      </form>
    </aside>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, GoogleAuthProvider, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKfQ4vW-oR-CGJ0bpRd-wF-nsawLk8X8w",
      authDomain: "testweb-afd53.firebaseapp.com",
      databaseURL: "https://testweb-afd53-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "testweb-afd53",
      storageBucket: "testweb-afd53.appspot.com",
      messagingSenderId: "256254284539",
      appId: "1:256254284539:web:2e3543191c27a36441165e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    const signBtn = document.getElementById('signBtn');
    const toggleMode = document.getElementById('toggleMode');
    const googleBtn = document.getElementById('googleBtn');
    const guestBtn = document.getElementById('guestBtn');
    const emailInput = document.getElementById('email');
    const pwdInput = document.getElementById('password');
    const rememberMe = document.getElementById('rememberMe');
    const secretBox = document.getElementById('secret');
    const SECRET_CODE = "letmein123";
    let creating = false;

    toggleMode.onclick = () => {
      creating = !creating;
      toggleMode.textContent = creating ? "Back to sign in" : "Create account";
      signBtn.textContent = creating ? "Create account" : "Sign in";
    };

    signBtn.onclick = async () => {
      const email = emailInput.value.trim(), pwd = pwdInput.value;
      if (!email || !pwd) return alert("Enter email and password");
      await setPersistence(auth, rememberMe.checked ? browserLocalPersistence : browserSessionPersistence);
      try {
        const userCred = creating
          ? await createUserWithEmailAndPassword(auth, email, pwd)
          : await signInWithEmailAndPassword(auth, email, pwd);
        await saveUsername(userCred.user);
      } catch (err) {
        alert(err.message);
      }
    };

    googleBtn.onclick = async () => {
      await setPersistence(auth, rememberMe.checked ? browserLocalPersistence : browserSessionPersistence);
      const userCred = await signInWithPopup(auth, provider);
      await saveUsername(userCred.user);
    };

    guestBtn.onclick = async () => {
      const userCred = await signInAnonymously(auth);
      await saveUsername(userCred.user);
    };

    async function saveUsername(user) {
      const uid = user.uid;
      const dbRef = ref(db);
      const snap = await get(child(dbRef, `usernames/${uid}`));
      let username = snap.exists() ? snap.val() : localStorage.getItem(`username_${uid}`);
      if (!username) {
        const code = secretBox.value.trim();
        while (true) {
          username = prompt("Choose a username (min 5 letters):") || "";
          if (username.length >= 5 || code === SECRET_CODE) break;
          alert("Too short unless you have the secret code!");
        }
        await set(ref(db, `usernames/${uid}`), username);
        localStorage.setItem(`username_${uid}`, username);
      }
      // ✅ Wait before redirect
      setTimeout(() => (window.location.href = "chatroom.html"), 500);
    }
  </script>
</body>
</html>
